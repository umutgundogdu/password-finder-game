<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şifre Bulma Oyunu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="mn.css">
</head>
<body>
        <!--alerts-->
        <div aria-live="polite" aria-atomic="true" class="position-relative" style="z-index: 999;">
            <div id="notification-area" class="toast-container position-absolute top-0 end-0 p-3"></div>
        </div>
        <div class="card shadow-none p-3 mb-5 bg-light rounded text-warning bg-dark">
            <div class="card-body">
            <h5 class="hood">Şifre Bulma Oyunu</h5>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title text-warning" id="exampleModalLabel">Oyun Ayarları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="customRange2" class="form-label text-success">Zorluk Derecesi: <span id="zorlukDerecesiLabel"></span></label>
                    <input id="range" type="range" class="form-range" min="1" max="4" id="customRange2">
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">çık</button>
                <button id="okayBtn" type="button" class="btn btn-primary">tamam</button>
                </div>
            </div>
            </div>
        </div>
        <!--cards-->
    <div class="card shadow-lg p-3 mb-5 bg-white rounded w-75 p-3 card-1">
        <div class="card-body">
            <div class="container">
                <div class="row">
                  <div class="col">
                <!--leftGrid-->
                    <img src="lock.png" alt="..." style="margin:auto; padding: 50px;">
                    <div id="basamakTahminAlani" class="d-flex justify-content" style="max-width: 10px;">                          
                        <div class="ipcu">                    
                            <button id="ipucu" type="button"  class="btn btn-dark lampBtn"></button>
                        </div>               
                    </div>
                <!--leftFinish-->
                  </div>
                <!--rightGrid-->
                  <div class="col">            
                    <div id="ipucular" style="min-width: auto;"></div>          
                        <div class="card-body">                            
                            <div class="input-group">
                                <button style="text-align: center;" type="button" class="btn btn-warning optionsBtn" data-bs-toggle="modal" data-bs-target="#exampleModal">Ayarlar</button>
                                <input id="resultInput" type="number" class="form-control" placeholder="100-999">
                                <button id="kontrolButonu" class="btn btn-warning type="button">kontrol</button>
                            </div>        
                        </div>                 
                <!--rightFinish-->
                  </div>
                </div>
              </div>                
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script>
            const kelimeler = {
                '-': "rakam doğru ama yanlış yerde",
                '+': "rakam doğru ve doğru yerde",
                '': "hiç bir şey doğru değil"
            };
            const zorlukDereceleri = {
                1:{
                    text: "kolay",
                    basamakSayisi: 3,
                    ipucuSayisi:2
                },
                2:{
                    text: "normal",
                    basamakSayisi: 4,
                    ipucuSayisi:2
                },
                3:{
                    text: "zor",
                    basamakSayisi: 5,
                    ipucuSayisi:2
                },
                4:{
                    text: "expert",
                    basamakSayisi: 6,
                    ipucuSayisi:2
                }
            }

            let range = document.getElementById("range");
            range.addEventListener("change",(e)=>{
                zorlukDerecesi = zorlukDereceleri[range.value+""];
                document.getElementById("zorlukDerecesiLabel").innerHTML = zorlukDerecesi.text;
            })
            
            let okayBtn = document.getElementById("okayBtn");         
            let resultInput = document.getElementById("resultInput");
            let kontrolButonu = document.getElementById("kontrolButonu");
            let ipucuButonu = document.getElementById("ipucu");
            kontrolButonu.addEventListener('mousedown', resultCheck);
            ipucuButonu.addEventListener('mousedown', ipucuIstegi);
            document.addEventListener('keydown', (e)=>{
                if(e.code == 'KeyR') {
                    createToast("success","Cevap : "+number);
                }
            });

            let zorlukDerecesi = zorlukDereceleri['1'];
            console.log(zorlukDerecesi);
            const ipucuE = 5;
            const minNumber = Math.pow(10, zorlukDerecesi.basamakSayisi-1);
            const maxNumber = Math.pow(10, zorlukDerecesi.basamakSayisi)-1;
            let {number, digits} = generateDifferentDigitNumber(minNumber, maxNumber);

            let ipucuNumaralari = [];

            // basamakların ipucularının durumunu tutar.
            let ipucuDurumu = [];

            let done
            do {
                done = false;
                for(let i=0;i<ipucuE;i++) {
                    ipucuNumaralari[i] = ipucuOlusturma();
                }
                let basamakE = {};
                digits.forEach(d=>{
                    basamakE[d] = 0;
                    ipucuNumaralari.forEach(hn=>{
                        if(hn.digits.includes(d)) {
                            basamakE[d] = (basamakE[d]||0) + 1;
                        }
                    });
                });

                done = digits.filter(d=>basamakE[d]==0).length==0;
            } while(!done);

            ipucuNumaralari.forEach(hn => {
                let kelime = [];
                if(hn.sign =="") {
                    kelime.push(kelimeler['']);
                } else {
                    let count = {};
                    hn.sign.split("").forEach(i => {
                        count[i] = (count[i]||0) + 1;
                    });
                    for (const dg in count) {
                        if (count[dg]) {
                            kelime.push(count[dg] + ' ' + kelimeler[dg]);
                        }
                    }
                }            
                document.getElementById("ipucular").innerHTML += '<div class="alert alert-warning" role="alert">'+hn.number+" &nbsp;&nbsp;&nbsp;"+kelime.join(' , ')+'</div>';
            });

            for(let i=0;i<zorlukDerecesi.basamakSayisi;i++) {
                ipucuDurumu[i] = {text: i, status: false};
                createDigitHTML(i);
                updateDigitHTML(i, '?', false);
            }

            //console.log(ipucuDurumu);

            function ipucuOlusturma() {
                let bulmak = false;
                let generatedNumObj;
                let signes;
                do {
                    //console.log("working");
                    generatedNumObj = generateDifferentDigitNumber(minNumber, maxNumber);
                    if(generatedNumObj.number == number) { // filtering the result - number
                        continue;
                    }
                    signes = "";
                    
                    for(let j=0;j<generatedNumObj.digits.length;j++) {
                        if(generatedNumObj.digits[j] == digits[j]) {
                            signes += "+";
                        } else if(digits.includes(generatedNumObj.digits[j])) {
                            signes +="-";
                        }
                    }

                    let digitFilter = digits.filter(ns=>generatedNumObj.digits.includes(ns));
                    if(digitFilter.length == 0) {
                        continue;
                    }
                    
                    bulmak = true;
                } while(!bulmak);

                return {sign: signes, number: generatedNumObj.number, digits: generatedNumObj.digits};
            }

            function createToast(type, text) {
                let toastHtml = 
                htmlToElement(
                    '<div class="toast d-flex align-items-center text-white bg-'+type+' border-0" role="alert" aria-live="assertive" aria-atomic="true">'+
                        '<div class="toast-body">'+
                            text+
                        '</div>'+
                        '<button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>'+
                    '</div>'
                );

                document.getElementById("notification-area").appendChild(toastHtml);

                let toast = new bootstrap.Toast(toastHtml);
                toastHtml.addEventListener('hidden.bs.toast', function (e) {
                    e.target.parentNode.removeChild(e.target);
                });
                toast.show();
            }

            //console.log(number);

            function htmlToElement(html) {
                var template = document.createElement('template');
                html = html.trim(); // Never return a text node of whitespace as the result
                template.innerHTML = html;
                return template.content.firstChild;
            }

            function createDigitHTML(num) {
                let html  = 
                '<div class="card digitareaText p-2 bd-highlight" style="min-width: 60px; height: 60px; margin:20px">'+
                    '<div class="card-body">'+
                      '<h5 id="digit-'+num+'" class="card-text"></h5>'+
                    '</div>'+
                '</div>';

                document.getElementById("basamakTahminAlani").appendChild(htmlToElement(html));// += html;
            }
            
            function updateDigitHTML(num, text, isOpen) {
                let d = document.getElementById("digit-"+num);
                d.innerHTML = "";                
                let parent = d.parentElement.parentElement;
                parent.classList.remove(!isOpen ? "digit-open" : "digit-close");
                parent.classList.add(!isOpen ? "digit-close" : "digit-open");
                d.appendChild(htmlToElement(text));
            }

            function generateDifferentDigitNumber(min, max) {
                let r, rd;
                do {
                    r = random(min, max);
                    rd = (r+"").split("");
                } while(!isDigitsDifferent(rd));
                return {number: r, digits: rd};
            }

            function isDigitsDifferent(arr) {
                return arr.length === new Set(arr).size
            }

            function ipucuIstegi() {
                let filtered = getFilterHintState();
                if(filtered.length > 0 && ipucuDurumu.length - zorlukDerecesi.ipucuSayisi < filtered.length) {
                    let r;
                    do {
                        r = random(0, ipucuDurumu.length-1);
                    } while(ipucuDurumu[r].status===true);

                    ipucuDurumu[r].text = digits[r];
                    ipucuDurumu[r].status = true;
                    updateDigitHTML(r, digits[r], true);
                }

                if(ipucuDurumu.length - zorlukDerecesi.ipucuSayisi >= getFilterHintState().length) {
                    ipucuButonu.setAttribute("disabled", "disabled");
                }
            }

            function getFilterHintState() {
                return ipucuDurumu.filter(hs => hs.status === false);
            }

            function resultCheck() {
                let result = resultInput.value;
                console.log();
                if(result>maxNumber || result<minNumber) {
                    createToast("danger","Lütfen "+minNumber+" - "+maxNumber+" arası sayı giriniz!");
                    alert("Lütfen "+minNumber+" - "+maxNumber+" arası sayı giriniz!");   
                } else {
                    let condition = result == number;
                    //alert(condition);
                    if(condition===true) {
                        playConfetti();
                    }else{
                        createToast("danger","Yanlış Cevap");
                    }
                }
            }

            function random(min, max) {
                return Math.floor((Math.random() * (max-min+1)) + min); 
            }

            function playConfetti() {
                var end = Date.now() + (3 * 1000);
                var colors = ['#bb0000', '#ffffff'];

                (function frame() {
                    confetti({
                        particleCount: 2,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: colors
                    });
                    confetti({
                        particleCount: 2,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: colors
                    });
                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                }());
            }

            function playConfetti_() {
                var count = 200;
                var defaults = {
                origin: { y: 0.7 }
                };

                function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
                }

                fire(0.25, {
                    spread: 26,
                    startVelocity: 55,
                });
                fire(0.2, {
                    spread: 60,
                });
                fire(0.35, {
                    spread: 100,
                    decay: 0.91,
                    scalar: 0.8
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 25,
                    decay: 0.92,
                    scalar: 1.2
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 45,
                });
            }
    </script>
</body>
</html>